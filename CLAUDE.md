# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Full-stack multi-tenant SaaS application: Go backends (Chi, SQLC, PostgreSQL) + SvelteKit frontends (Svelte 5, TypeScript, Tailwind).

## Architecture

```
                    ┌──────────────┐
                    │   database/  │  PostgreSQL schema + migrations (goose)
                    └──────┬───────┘
                    ┌──────┴───────┐
                    │   jirachi/   │  Shared Go library (auth, jwt, errlib, etc.)
                    └──┬───────┬───┘
          ┌────────────┴─┐   ┌─┴──────────────┐
          │lugia-backend │   │giratina-backend │  Go HTTP servers
          │  (customer)  │   │  (internal admin)│
          └──────┬───────┘   └──────┬──────────┘
                    ┌──────────────┐
                    │   zoroark/   │  Shared Svelte 5 component library
                    └──┬───────┬───┘
        ┌──────────────┴─┐   ┌─┴────────────────┐
        │lugia-frontend  │   │giratina-frontend  │  SvelteKit apps
        └────────────────┘   └───────────────────┘
```

| Directory | What it is | Language |
|---|---|---|
| `database/` | Schema migrations (goose), seed data, drop script | SQL |
| `jirachi/` | Shared Go library — auth, authz, context, error handling, JWT, rate limiting, SQLC queries | Go |
| `lugia-backend/` | Customer-facing API server | Go |
| `giratina-backend/` | Internal admin API server | Go |
| `zoroark/` | Shared Svelte 5 component library (Button, Input, Alert, Toast, etc.) | Svelte/TS |
| `lugia-frontend/` | Customer-facing SvelteKit app | Svelte/TS |
| `giratina-frontend/` | Internal admin SvelteKit app | Svelte/TS |
| `infrastructure/` | Pulumi IaC for GCP deployment | TypeScript |
| `sendgrid-mock/` | Mock SendGrid server for dev | Node.js |
| `keycloak-mock/` | Mock Keycloak server for SSO dev | Shell |

### Dependency direction

- Backends depend on `jirachi/` — never the other way around
- Frontends depend on `zoroark/` — never the other way around
- `jirachi/` and `zoroark/` must NOT depend on any backend or frontend module
- `database/` is standalone — migrations are shared by all Go modules

## Essential commands

```bash
make dev              # Start all services (6 processes)
make verify           # Lint + typecheck + unit test everything
make generate         # Regenerate all SQLC across all modules
make migrate          # Run database migrations
make initdb           # Drop + migrate + seed (destructive)
```

## Session startup protocol

When starting a new session or resuming after context compaction:

1. **Orient** — Read `PROGRESS.md` to understand what's done, in flight, and next
2. **Verify baseline** — Run `make verify` to confirm the codebase is in a clean state before making changes
3. **Understand the task** — Read relevant code and CLAUDE.md files before implementing
4. **Work incrementally** — One logical change at a time, verify after each change

## General guidelines

- **Accuracy over speed** — understand the problem and plan before writing code. Ask clarifying questions.
- **Verify changes work** — test happy path, edge cases, and failure modes. Fix root causes, not symptoms.
- **Root cause over workaround** — fix the underlying cause, not the surface symptom. Flag it if the root cause fix is significantly more work.
- **Task scope** — focus exclusively on the task at hand. Note unrelated improvements as comments, don't implement them.
- **Comments explain WHY, not WHAT** — see `docs/conventions.md` for examples.
- **Locality of behavior** — code that belongs together should live together. Only separate with good reason.
- **Follow existing patterns** — study the codebase first. Use existing types, match existing interfaces, follow naming conventions.
- **Design for concurrent access** — when introducing shared artifacts (files, configs, state), consider who reads and writes them. If multiple processes might write to the same file, externalize mutable state to a coordination system. Keep shared files read-mostly.
- **Prefer simplicity** — simple interfaces, direct solutions, type safety, minimal dependencies.

## Key rules

### Generated code boundaries

Files in `queries/` directories are generated by SQLC. **Never hand-edit them.** Edit SQL in `queries_pregeneration/`, run `make generate`, commit both.

### Shared resource blast radius

| Resource | Consumed by | Impact |
|---|---|---|
| `database/migrations/` | All Go modules | Schema changes affect all backends |
| `jirachi/` | lugia-backend, giratina-backend | Library changes affect both backends |
| `zoroark/` | lugia-frontend, giratina-frontend | Component changes affect both frontends |
| `database/seed.sql` | Local dev setup | Seed changes can break local dev for all modules |

When changing a shared resource, verify all consumers still work by running `make verify`.

## Definition of Done

1. **Code works**: The feature/fix functions as intended
2. **Each change verified**: After every discrete change, verify it works (run the relevant tool, check the output, confirm the behavior). Do not batch multiple changes and verify once at the end.
3. **Full verification passes**: `make verify` passes from the repo root
4. **Scope is clean**: No unrelated changes in the diff
5. **Generated code is correct**: If queries changed, `make generate` was run (not hand-edited)
6. **Self-reviewed**: `/review` was run and issues addressed

## Escalation protocol

**Stop and ask** when: ambiguous requirements, shared resource changes you're unsure about, security decisions, destructive operations, scope creep, or you're blocked after two attempts.

**Don't ask** when: the task is well-defined, you're following existing patterns, or the change is contained to a single module.

## Deeper documentation

| Document | What it covers |
|---|---|
| `docs/conventions.md` | Detailed coding conventions with examples |
| `docs/harness/implementation-plan.md` | Harness engineering roadmap and tier system |
| `PROGRESS.md` | Current state: what's done, in flight, and next |
| `lugia-backend/CLAUDE.md` | Customer backend: handlers, middleware, enterprise features |
| `giratina-backend/CLAUDE.md` | Admin backend: handlers, tenant management |
| `lugia-frontend/CLAUDE.md` | Customer frontend: routes, components, fetch patterns |
| `giratina-frontend/CLAUDE.md` | Admin frontend: routes, components |
| `jirachi/CLAUDE.md` | Shared Go library: packages, key rules |
| `zoroark/CLAUDE.md` | Shared UI library: components, build process |
